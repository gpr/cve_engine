module CveEngine

  # NVD Vulnerability
  #
  # rails g model Vulnerability cve_id:string is_cce_id:boolean discovered_datetime:datetime disclosure_datetime:datetime exploit_publish_datetime:datetime published_datetime:datetime last_modified_datetime:datetime security_protection:string summary:string
  #
  # app/assets/schema/vulnerability_0.4.xsd
  #
  # ```xml
  #<xsd:element name="osvdb-ext" type="osvdbExtensionType" minOccurs="0"/>
  #<xsd:element name="vulnerable-configuration" type="cpe-lang:PlatformType" minOccurs="0" maxOccurs="unbounded"/>
  #<xsd:element name="vulnerable-software-list" type="vulnerableSoftwareType" minOccurs="0"/>
  #<xsd:choice minOccurs="0">
  #  <xsd:element name="cve-id" type="cve:cveNamePatternType"/>
  #  <xsd:element name="cce-id" type="cce:cceNamePatternType"/>
  #</xsd:choice>
  #<xsd:element name="discovered-datetime" type="xsd:dateTime" minOccurs="0"/>
  #<xsd:element name="disclosure-datetime" type="xsd:dateTime" minOccurs="0"/>
  #<xsd:element name="exploit-publish-datetime" type="xsd:dateTime" minOccurs="0"/>
  #<xsd:element name="published-datetime" type="xsd:dateTime" minOccurs="0"/>
  #<xsd:element name="last-modified-datetime" type="xsd:dateTime" minOccurs="0"/>
  #<xsd:element name="cvss" type="cvssv2:cvssImpactType" minOccurs="0"/>
  #<xsd:element name="security-protection" type="securityProtectionType" minOccurs="0"/>
  #<xsd:element name="assessment_check" type="scap-core:checkReferenceType" maxOccurs="unbounded" minOccurs="0"/>
  #<xsd:element name="cwe" type="cweReferenceType" minOccurs="0" maxOccurs="unbounded"/>
  #<xsd:element name="references" type="vulnerabilityReferenceType" minOccurs="0" maxOccurs="unbounded"/>
  #<xsd:element name="fix_action" type="fixActionType" minOccurs="0" maxOccurs="unbounded"/>
  #<xsd:element name="scanner" type="toolConfigurationType" minOccurs="0" maxOccurs="unbounded" />
  #<xsd:element name="summary" type="xsd:string" minOccurs="0"/>
  #<xsd:element name="technical_description" type="scap-core:referenceType" minOccurs="0" maxOccurs="unbounded"/>
  #<xsd:element name="attack_scenario" type="scap-core:referenceType" minOccurs="0" maxOccurs="unbounded" />
  #```
  class Vulnerability < ActiveRecord::Base
    # -----------------------------------------------------
    # Constants
    SECURITY_PROTECTIONS = ["ALLOWS_ADMIN_ACCESS", "ALLOWS_USER_ACCESS", "ALLOWS_OTHER_ACCESS"]
    # -----------------------------------------------------
    # Inclusion / Extension (acts_as)

    # -----------------------------------------------------
    # Associations
    #TODO has_one :osvdb_ext
    #TODO has_one :cvss

    #TODO has_many :vulnerable_configurations
    #TODO has_many :cpe_products
    #TODO has_many :assessment_checks
    #TODO has_many :cwes
    #TODO has_many :references
    #TODO has_many :fix_actions
    #TODO has_many :scanners
    #TODO has_many :technical_descriptions
    #TODO has_many :attack_scenarios

    # -----------------------------------------------------
    # Validations
    validates :cve_id, presence: true, uniqueness: true
    validates :security_protection, inclusion: {in: SECURITY_PROTECTIONS, allow_nil: true}

    # -----------------------------------------------------
    # Hooks

    # -----------------------------------------------------
    # Instance methods
    def security_protection_enum
      SECURITY_PROTECTIONS
    end

    #def vulnerable_software_list
    #  self.cpe_products
    #end

    # -----------------------------------------------------
    # Class methods


    # -----------------------------------------------------
    # Private methods
    private

    # -----------------------------------------------------
    # rails_admin configuration
    rails_admin do
      list do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      show do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      edit do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      create do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      update do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      nested do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end

      modal do
        field :cve_id
        field :is_cce_id
        field :discovered_datetime
        field :disclosure_datetime
        field :exploit_publish_datetime
        field :published_datetime
        field :last_modified_datetime
        field :security_protection
        field :summary
      end
    end
  end
end
