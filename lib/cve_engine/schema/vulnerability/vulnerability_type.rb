module CveEngine
  module Schema
    module Vulnerability

      require 'roxml'

      require 'cve_engine/schema/vulnerability/vulnerable_software_list'
      require 'cve_engine/schema/cvss/cvss_impact_type'

      #      <xsd:element name="osvdb-ext" type="osvdbExtensionType" minOccurs="0"/>
      #      <xsd:element name="vulnerable-configuration" type="cpe-lang:PlatformType" minOccurs="0" maxOccurs="unbounded"/>
      #      <xsd:element name="vulnerable-software-list" type="vulnerableSoftwareType" minOccurs="0"/>
      #      <xsd:choice minOccurs="0">
      #        <xsd:element name="cve-id" type="cve:cveNamePatternType"/>
      #        <xsd:element name="cce-id" type="cce:cceNamePatternType"/>
      #      </xsd:choice>
      #      <xsd:element name="discovered-datetime" type="xsd:dateTime" minOccurs="0"/>
      #      <xsd:element name="disclosure-datetime" type="xsd:dateTime" minOccurs="0"/>
      #      <xsd:element name="exploit-publish-datetime" type="xsd:dateTime" minOccurs="0"/>
      #      <xsd:element name="published-datetime" type="xsd:dateTime" minOccurs="0"/>
      #      <xsd:element name="last-modified-datetime" type="xsd:dateTime" minOccurs="0"/>
      #      <xsd:element name="cvss" type="cvssv2:cvssImpactType" minOccurs="0"/>
      #      <xsd:element name="security-protection" type="securityProtectionType" minOccurs="0"/>
      #      <xsd:element name="assessment_check" type="scap-core:checkReferenceType" maxOccurs="unbounded" minOccurs="0"/>
      #      <xsd:element name="cwe" type="cweReferenceType" minOccurs="0" maxOccurs="unbounded"/>
      #      <xsd:element name="references" type="vulnerabilityReferenceType" minOccurs="0" maxOccurs="unbounded"/>
      #      <xsd:element name="fix_action" type="fixActionType" minOccurs="0" maxOccurs="unbounded"/>
      #      <xsd:element name="scanner" type="toolConfigurationType" minOccurs="0" maxOccurs="unbounded">
      #      <xsd:element name="summary" type="xsd:string" minOccurs="0"/>
      #      <xsd:element name="technical_description" type="scap-core:referenceType" minOccurs="0" maxOccurs="unbounded"/>
      #      <xsd:element name="attack_scenario" type="scap-core:referenceType" minOccurs="0" maxOccurs="unbounded">
      class VulnerabilityType
        include ROXML

        xml_name :entry
        xml_reader :id, from: '@id'

        xml_namespace 'vuln'

        #TODO xml_reader :osvdb_ext, as: OsvdbExtensionType, from: 'osvdb-ext'
        #TODO xml_accessor :vulnerable_configuration, as: CpeLanguage::PlatformType, from: 'vulnerable-configuration'
        xml_accessor :vulnerable_software_list, as: VulnerableSoftwareType, from: 'vulnerable-software-list'
        xml_reader :cve_id, from: 'cve-id'
        xml_reader :cce_id, from: 'cce-id'
        xml_reader :discovered_datetime, from: 'discovered-datetime'
        xml_reader :disclosure_datetime, from: 'disclosure-datetime'
        xml_reader :exploit_publish_datetime, from: 'exploit-publish-datetime'
        xml_reader :published_datetime, from: 'exploit-publish-datetime'
        xml_reader :last_modified_datetime, from: 'last-modified-datetime'
        xml_accessor :cvss, as: Cvss::CvssImpactType, from: 'cvss'
        xml_accessor :security_protection, from: 'security-protection'
        #TODO xml_accessor :assessment_checks, as: [AssessmentCheck], from: 'assessment_check'
        #TODO xml_accessor :cwe, as: [Cwe], from: 'cwe'
        #TODO xml_accessor :references_list, as: [VulnerabilityReference], from: 'references'
        #TODO xml_accessor :fix_actions, as: [FixAction], from: 'fix_action'
        #TODO xml_accessor :scanners, as: [Scanner], from: 'scanner'
        xml_reader :summary, from: 'summary'
        #TODO xml_accessor :technical_descriptions, as: [TechnicalDescription], from: 'technical_description'
        #TODO xml_accessor :attack_scenarios, as: [AttackScenario], from: 'attack_scenario'

        def is_cce_id?
          not cce_id.blank?
        end

        def to_s
          str  = "#{id}\n"
          str += "  - cve-id: #{cve_id}\n" if cve_id
          str += "  - cce-id: #{cce_id}\n" if cce_id
          str += "  - discovered-datetime: #{discovered_datetime}\n" if discovered_datetime
          str += "  - disclosure-datetime: #{disclosure_datetime}\n" if disclosure_datetime
          str += "  - exploit-publish-datetime: #{exploit_publish_datetime}\n" if exploit_publish_datetime
          str += "  - published-datetime: #{published_datetime}\n" if published_datetime
          str += "  - last-modified-datetime: #{last_modified_datetime}\n" if last_modified_datetime
          str += "  - cvss:\n#{cvss.to_s("      ")}" if cvss
          str += "  - security-protection: #{security_protection}\n" if security_protection
          str += "  - summary: #{summary}\n" if summary
          str
        end
      end
    end
  end
end